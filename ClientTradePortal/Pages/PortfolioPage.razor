@page "/portfolio"
@using Fluxor
@using ClientTradePortal.Store.Account
@using MudBlazor
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@inject IState<AccountState> AccountState
@inject IDispatcher Dispatcher
@inject NavigationManager Navigation

<PageTitle>Portfolio</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
        My Portfolio
    </MudText>

    @if (AccountState.Value.IsLoading)
    {
        <MudPaper Class="pa-8 text-center" Elevation="2">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Loading portfolio...</MudText>
        </MudPaper>
    }
    else if (AccountState.Value.CurrentAccount != null)
    {
        var account = AccountState.Value.CurrentAccount;
        var totalStockValue = account.Positions.Sum(p => p.TotalValue);
        var totalPortfolioValue = account.CashBalance + totalStockValue;
        var totalProfitLoss = account.Positions.Sum(p => p.ProfitLoss);

        <MudGrid>
            @* Portfolio Summary Cards *@
            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Value</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Primary">
                                €@totalPortfolioValue.ToString("N2")
                            </MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" 
                                 Size="Size.Large" 
                                 Color="Color.Primary" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Cash Balance</MudText>
                            <MudText Typo="Typo.h4">€@account.CashBalance.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.Euro" 
                                 Size="Size.Large" 
                                 Color="Color.Success" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Stocks Value</MudText>
                            <MudText Typo="Typo.h4">€@totalStockValue.ToString("N2")</MudText>
                        </div>
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" 
                                 Size="Size.Large" 
                                 Color="Color.Info" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <div>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total P/L</MudText>
                            <MudText Typo="Typo.h4" Color="@(totalProfitLoss >= 0 ? Color.Success : Color.Error)">
                                @(totalProfitLoss >= 0 ? "+" : "")€@totalProfitLoss.ToString("N2")
                            </MudText>
                        </div>
                        <MudIcon Icon="@(totalProfitLoss >= 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)" 
                                 Size="Size.Large" 
                                 Color="@(totalProfitLoss >= 0 ? Color.Success : Color.Error)" />
                    </MudStack>
                </MudPaper>
            </MudItem>

            @* Portfolio Allocation Chart *@
            <MudItem xs="12" md="5">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.PieChart" Class="mr-2" />
                        Portfolio Allocation
                    </MudText>
                    
                    @if (account.Positions.Count > 0)
                    {
                        <MudChart ChartType="ChartType.Donut" 
                                  Width="300px" 
                                  Height="300px"
                                  InputData="@GetAllocationData()" 
                                  InputLabels="@GetAllocationLabels()"
                                  ChartOptions="@_chartOptions" />
                        
                        <MudDivider Class="my-3" />
                        
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2">Cash</MudText>
                                <MudText Typo="Typo.body2" Class="font-weight-bold">
                                    @((account.CashBalance / totalPortfolioValue * 100).ToString("N1"))%
                                </MudText>
                            </MudStack>
                            @foreach (var position in account.Positions)
                            {
                                <MudStack Row="true" Justify="Justify.SpaceBetween">
                                    <MudText Typo="Typo.body2">@position.Symbol</MudText>
                                    <MudText Typo="Typo.body2" Class="font-weight-bold">
                                        @((position.TotalValue / totalPortfolioValue * 100).ToString("N1"))%
                                    </MudText>
                                </MudStack>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            No stock positions yet. Start trading to build your portfolio!
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            @* Performance Overview *@
            <MudItem xs="12" md="7">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" />
                            Performance Overview
                        </MudText>
                        <MudButton StartIcon="@Icons.Material.Filled.Refresh" 
                                   Color="Color.Primary" 
                                   Variant="Variant.Outlined"
                                   Size="Size.Small"
                                   OnClick="@RefreshPortfolio">
                            Refresh
                        </MudButton>
                    </MudStack>

                    @if (account.Positions.Count > 0)
                    {
                        <MudStack Spacing="3">
                            @foreach (var position in account.Positions.OrderByDescending(p => p.TotalValue))
                            {
                                var profitLossPercent = position.ProfitLossPercentage;
                                var isProfit = profitLossPercent >= 0;

                                <MudPaper Class="pa-3" Elevation="0" Style="border-left: 4px solid var(--mud-palette-primary);">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.h6">@position.Symbol</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                @position.Quantity shares • Avg. €@position.AveragePrice.ToString("N2")
                                            </MudText>
                                        </div>
                                        <div class="text-right">
                                            <MudText Typo="Typo.h6">€@position.TotalValue.ToString("N2")</MudText>
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="@(isProfit ? Color.Success : Color.Error)"
                                                     Icon="@(isProfit ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)">
                                                @(isProfit ? "+" : "")@profitLossPercent.ToString("N2")%
                                            </MudChip>
                                        </div>
                                    </MudStack>
                                    <MudDivider Class="my-2" />
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption">
                                            Current: €@position.CurrentPrice.ToString("N2")
                                        </MudText>
                                        <MudText Typo="Typo.caption" Color="@(isProfit ? Color.Success : Color.Error)">
                                            P/L: @(isProfit ? "+" : "")€@position.ProfitLoss.ToString("N2")
                                        </MudText>
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                            Your portfolio is empty. Visit the <MudLink Href="/trade">Trading page</MudLink> to make your first purchase!
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>

            @* Holdings Table *@
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.TableChart" Class="mr-2" />
                        Holdings Details
                    </MudText>

                    @if (account.Positions.Count > 0)
                    {
                        <MudTable Items="@account.Positions" 
                                  Hover="true" 
                                  Breakpoint="Breakpoint.Sm"
                                  Dense="false"
                                  Striped="true">
                            <HeaderContent>
                                <MudTh>Symbol</MudTh>
                                <MudTh Class="text-right">Quantity</MudTh>
                                <MudTh Class="text-right">Avg. Price</MudTh>
                                <MudTh Class="text-right">Current Price</MudTh>
                                <MudTh Class="text-right">Total Cost</MudTh>
                                <MudTh Class="text-right">Market Value</MudTh>
                                <MudTh Class="text-right">Profit/Loss</MudTh>
                                <MudTh Class="text-right">P/L %</MudTh>
                                <MudTh>Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Symbol">
                                    <MudChip T="string"  Color="Color.Primary">@context.Symbol</MudChip>
                                </MudTd>
                                <MudTd DataLabel="Quantity" Class="text-right">
                                    <MudText Typo="Typo.body2">@context.Quantity</MudText>
                                </MudTd>
                                <MudTd DataLabel="Avg. Price" Class="text-right">
                                    <MudText Typo="Typo.body2">€@context.AveragePrice.ToString("N2")</MudText>
                                </MudTd>
                                <MudTd DataLabel="Current Price" Class="text-right">
                                    <MudText Typo="Typo.body2" Class="font-weight-bold">
                                        €@context.CurrentPrice.ToString("N2")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Total Cost" Class="text-right">
                                    <MudText Typo="Typo.body2">€@context.TotalCost.ToString("N2")</MudText>
                                </MudTd>
                                <MudTd DataLabel="Market Value" Class="text-right">
                                    <MudText Typo="Typo.body2" Class="font-weight-bold">
                                        €@context.TotalValue.ToString("N2")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Profit/Loss" Class="text-right">
                                    <MudText Typo="Typo.body2" 
                                             Color="@(context.ProfitLoss >= 0 ? Color.Success : Color.Error)"
                                             Class="font-weight-bold">
                                        @(context.ProfitLoss >= 0 ? "+" : "")€@context.ProfitLoss.ToString("N2")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="P/L %" Class="text-right">
                                    <MudChip T="string" Size="Size.Small"
                                             Color="@(context.ProfitLossPercentage >= 0 ? Color.Success : Color.Error)"
                                             Icon="@(context.ProfitLossPercentage >= 0 ? Icons.Material.Filled.TrendingUp : Icons.Material.Filled.TrendingDown)">
                                        @(context.ProfitLossPercentage >= 0 ? "+" : "")@context.ProfitLossPercentage.ToString("N2")%
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudButton Size="Size.Small" 
                                               Variant="Variant.Text" 
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.ShoppingCart"
                                               OnClick="@(() => BuyMore(context.Symbol))">
                                        Buy More
                                    </MudButton>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">
                            No holdings to display. Start trading to build your portfolio!
                        </MudAlert>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">
            Unable to load portfolio data. Please try refreshing the page.
        </MudAlert>
    }
</MudContainer>

@code {
    private Guid _accountId = Guid.Parse("11111111-1111-1111-1111-111111111111");

    private ChartOptions _chartOptions = new ChartOptions
    {
        ChartPalette = new[] 
        { 
            "#2196F3", "#4CAF50", "#FF9800", "#F44336", "#9C27B0", 
            "#00BCD4", "#FFEB3B", "#795548", "#607D8B" 
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        LoadPortfolio();
    }

    private void LoadPortfolio()
    {
        Dispatcher.Dispatch(new LoadAccountAction(_accountId));
    }

    private void RefreshPortfolio()
    {
        LoadPortfolio();
    }

    private void BuyMore(string symbol)
    {
        Navigation.NavigateTo("/trade");
    }

    private double[] GetAllocationData()
    {
        var account = AccountState.Value.CurrentAccount;
        if (account == null) return Array.Empty<double>();

        var totalValue = account.CashBalance + account.Positions.Sum(p => p.TotalValue);
        var data = new List<double> { (double)account.CashBalance };
        data.AddRange(account.Positions.Select(p => (double)p.TotalValue));
        
        return data.ToArray();
    }

    private string[] GetAllocationLabels()
    {
        var account = AccountState.Value.CurrentAccount;
        if (account == null) return Array.Empty<string>();

        var labels = new List<string> { "Cash" };
        labels.AddRange(account.Positions.Select(p => p.Symbol));
        
        return labels.ToArray();
    }
}